---
title: "Multiverse Meta-Analysis with metaMultiverse"
author: "Constantin Yves Plessen"
date: "`r Sys.Date()`"
execute:
  cache: true
  warning: false
  message: false
format:
  html:
    minimal: true
    theme: none
    css: modern-styles.css
    toc: true
    toc-location: left
    code-fold: true
    code-tools: true
vignette: >
%\VignetteIndexEntry{Multiverse Meta-Analysis with metaMultiverse}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
  ---
  
  ```{r setup, include=FALSE}
knitr::opts_chunk$set(
warning = FALSE,
message = FALSE,
comment = "#>",
fig.width = 8,
fig.height = 6,
fig.retina = 2,
out.width = "100%"
)

library(metaMultiverse)
library(dplyr)
```

## Introduction

Meta-analysis faces a fundamental challenge: researchers must make numerous analytical decisions that can substantially impact results. Which studies should be included? How should effect sizes be aggregated? What statistical model is most appropriate? The **multiverse approach** addresses this challenge by systematically exploring how different combinations of defensible choices affect conclusions.

This vignette introduces the theoretical framework underlying multiverse meta-analysis and demonstrates how `metaMultiverse` implements these principles through an intuitive pipeline.

## Theoretical Framework

### The Decision Space

Meta-analytic decisions fall into two fundamental categories:

1. **"Which" decisions**: Which data to include?
- Study quality thresholds
- Population characteristics
- Measurement approaches
- Time periods

2. **"How" decisions**: How to analyze the data?
- Statistical models (fixed vs. random effects)
- Dependency handling strategies
- Bias correction methods

### Types of Analytical Choices

Not all decisions are created equal. We distinguish three types:

- **Equivalent (E)**: Options are theoretically interchangeable
- Example: Including studies from US vs. Europe when studying universal phenomena

- **Uncertain (U)**: The optimal choice is unclear
- Example: Risk of bias thresholds when quality assessment is subjective

- **Non-equivalent (N)**: Options address different research questions
- Example: Child vs. adult populations when developmental differences are expected

This typology has profound implications: E and U decisions create variations within a single multiverse, while N decisions spawn separate multiverses—distinct analytical spaces addressing related but different questions.

## Implementation in metaMultiverse

The package implements these principles through a clean, pipeable workflow:

```{r workflow, eval=FALSE}
results <- data %>%
  check_data_multiverse() %>%
  define_factors(...) %>%
  create_multiverse_specifications() %>%
  run_multiverse_analysis()
```

Let's explore each step with a concrete example.

## Example: Technology-Assisted Depression Treatment

We'll analyze a meta-analysis examining the effectiveness of technology-assisted interventions for depression, where researchers face multiple defensible analytical choices.

```{r load-data}
# Load example dataset
data("data_digDep") 

# Examine structure
glimpse(data_digDep)
```

### Step 1: Data Validation

First, ensure the data meets requirements:

```{r validate}
data_validated <- data_digDep %>%
  check_data_multiverse()
```

### Step 2: Define Which Factors

Now we specify our analytical choices. The package automatically detects whether you want simple (each level + all) or custom groupings:

```{r define-factors}
setup <- data_validated %>%
  define_factors(
    Population = "wf_3|U",
    Technology = "wf_2|N",
    Risk_of_Bias = list(
      "wf_7",
      decision = "U",
      groups = list( 
        "low_risk_only" = "low risk",
        "exclude_high_risk" = c("low risk", "some concerns"),
        "all_studies" = c("low risk", "some concerns", "high risk")
      )
    )
  )
```

The output shows how factors will be handled:

- **Technology (E)**: All options included in multiverse
- **Population (U)**: Uncertainty about optimal choice
- **Risk_of_Bias (U)**: Custom thresholds for quality
- **Therapy_Approach (N)**: Creates separate analyses for CBT-based vs. other approaches

### Step 3: Create Specifications

Generate all combinations of analytical choices:

```{r create-specs}
specs <- setup %>%
  create_multiverse_specifications(
    ma_methods = c("reml", "fe", "pet-peese"),  # Meta-analytic methods
    dependencies = c("aggregate", "modeled")     # Dependency handling
  )
```

This creates a grid where:
- Each row represents one complete analysis
- Invalid combinations (e.g., fixed effects with modeled dependencies) are automatically filtered
- Non-equivalent factors create separate `multiverse_id` values

### Step 4: Run Analyses

Execute all specifications:

```{r run-analysis, eval=FALSE}
multiverse <- specs %>%
  run_multiverse_analysis(verbose = TRUE)
```

### Step 5: Visualize Results

The package provides two main visualizations:

```{r visualize, eval=FALSE}
# Specification curve: see all results and their specifications
multiverse %>% 
  plot_spec_curve()

# Vibration of effects: explore result stability
multiverse %>% 
  plot_voe(cutoff = 10)  # Only show analyses with 10+ studies
```

## Advanced Features

### Custom Factor Groupings

For complex inclusion criteria, define sophisticated groupings:

```{r custom-groups, eval=FALSE}
define_factors(
  data,
  Study_Quality = list(
    "quality_score",
    decision = "U",
    groups = list(
      high_quality = c("A", "B"),
      moderate_quality = c("A", "B", "C"),
      all_quality = c("A", "B", "C", "D", "F")
    )
  ),
  
  Sample_Size = list(
    "n_participants",
    decision = "E",
    groups = list(
      large_studies = "large",
      medium_large = c("medium", "large"),
      all_sizes = c("small", "medium", "large")
    )
  )
)
```

### Multiple Multiverses

When using N-type factors, the package automatically:
1. Creates separate analyses for each level
2. Visualizes them separately in plots
3. Reports results by multiverse

```{r non-equivalent, eval=FALSE}
# This creates separate multiverses for each delivery mode
define_factors(
  data,
  Delivery_Mode = "delivery|N"  # Online vs. face-to-face
)
```

### Method Selection

Choose specific methods based on your needs:

```{r methods, eval=FALSE}
# See all available methods
list_ma_methods()

# Use specific methods
create_multiverse_specifications(
  setup,
  ma_methods = c("reml", "mm", "pb"),     # Only robust methods
  dependencies = "aggregate"                # Only aggregation
)
```

## Theoretical Considerations

### When to Use Multiverse Analysis

Multiverse analysis is particularly valuable when:

1. **Multiple defensible choices exist**: Different thresholds, populations, or methods could reasonably be applied
2. **Decisions may impact conclusions**: The analytical path might influence results
3. **Transparency is crucial**: Showing robustness across specifications builds confidence

### Interpreting Results

When examining multiverse results, consider:

1. **Consistency**: Do conclusions hold across most specifications?
2. **Specification importance**: Which choices drive variation in results?
3. **Theoretical alignment**: Do theoretically similar specifications yield similar results?

### Reporting Guidelines

A complete multiverse analysis report should include:

1. **Decision justification**: Why each choice was included
2. **Decision types**: Which choices are E, U, or N
3. **Specification curve**: Visual representation of all results
4. **Inferential statistics**: Proportion of significant results, median effect size
5. **Robustness assessment**: Identification of influential specifications

## Conclusion

Multiverse meta-analysis transforms the challenge of analytical flexibility into an opportunity for comprehensive understanding. By systematically exploring the decision space, researchers can:

- Assess the robustness of their conclusions
- Identify influential analytical choices
- Communicate uncertainty transparently
- Build stronger cumulative science

The `metaMultiverse` package makes this approach accessible through an intuitive pipeline that handles the computational complexity while preserving theoretical clarity.

## References

Voracek, M., Kossmeier, M., & Tran, U. S. (2019). Which data to meta-analyze, and how? A specification-curve and multiverse-analysis approach to meta-analysis. *Zeitschrift für Psychologie*, 227(1), 64-82.

Steegen, S., Tuerlinckx, F., Gelman, A., & Vanpaemel, W. (2016). Increasing transparency through a multiverse analysis. *Perspectives on Psychological Science*, 11(5), 702-712.
